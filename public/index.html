<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Public Chat</title>
  <style>
    /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è */
    
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä–∞ */
    .message {
      opacity: 0;
      transform: translateY(10px);
      animation: messageAppear 0.3s ease-out forwards;
    }
    
    @keyframes messageAppear {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .typing-indicator {
      padding: 8px 16px;
      color: #86a0bb;
      font-size: 14px;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    
    .typing-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .typing-dots {
      display: flex;
      gap: 3px;
    }
    
    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #3b82f6;
      animation: typingDot 1.4s ease-in-out infinite both;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typingDot {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .message-sending {
      opacity: 0.6;
    }
    
    .message-sent {
      animation: messageHighlight 1s ease;
    }
    
    @keyframes messageHighlight {
      0% {
        background: rgba(59, 130, 246, 0.1);
      }
      100% {
        background: transparent;
      }
    }
    
    .avatar-typing {
      position: relative;
    }
    
    .avatar-typing::after {
      content: '';
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background: #3b82f6;
      border-radius: 50%;
      border: 2px solid #0b1220;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.8);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.7;
      }
      100% {
        transform: scale(0.8);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- –í—Å–µ HTML —Ä–∞–∑–º–µ—Ç–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->

  <script>
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentChannel = 'general';
    let channels = {};
    let currentAvatarFile = null;
    let isTyping = false;
    let typingTimeout = null;
    let longPolling = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ long polling
    function startLongPolling() {
      if (longPolling) return;
      
      const poll = async () => {
        try {
          const response = await apiCall(`/channels/${currentChannel}/updates?lastUpdate=${Date.now()}`);
          
          if (response.type === 'new_message') {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            addNewMessage(response.message);
          } else if (response.type === 'typing_update') {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
            updateTypingIndicator(response.users);
          } else if (response.type === 'message_deleted') {
            // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            removeMessage(response.messageId);
          } else if (response.type === 'message_updated') {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            updateMessage(response.message);
          }
          
          // –°—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å
          poll();
        } catch (error) {
          console.error('Long polling error:', error);
          // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
          setTimeout(poll, 2000);
        }
      };
      
      poll();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    function sendTypingStatus(isTyping) {
      if (isTyping === isTyping) return;
      
      isTyping = isTyping;
      apiCall(`/channels/${currentChannel}/typing`, {
        method: 'POST',
        body: JSON.stringify({ isTyping })
      }).catch(console.error);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    function addNewMessage(message) {
      const messagesEl = document.getElementById('messages');
      const currentUser = localStorage.getItem('chat_username');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const existingMessage = messagesEl.querySelector(`[data-message-id="${message.id}"]`);
      if (existingMessage) return;
      
      const el = createMessageElement(message, currentUser);
      messagesEl.appendChild(el);
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
      messagesEl.scrollTop = messagesEl.scrollHeight;
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      setTimeout(() => {
        el.classList.add('message-sent');
      }, 100);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    function createMessageElement(msg, currentUser) {
      const el = document.createElement('div');
      el.className = 'message';
      el.dataset.messageId = msg.id;
      
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      if (msg.avatar) {
        const img = document.createElement('img');
        img.src = msg.avatar;
        img.alt = msg.username;
        avatar.appendChild(img);
      } else {
        avatar.textContent = initials(msg.username);
      }
      
      const body = document.createElement('div');
      body.className = 'message-body' + (msg.username === currentUser ? ' own-message' : '');
      
      const header = document.createElement('div');
      header.className = 'message-header';
      
      const nickEl = document.createElement('div');
      nickEl.className = 'nickname';
      nickEl.textContent = msg.username;
      
      const timeEl = document.createElement('div');
      timeEl.className = 'time';
      timeEl.textContent = formatTime(msg.timestamp);
      if (msg.edited) {
        const editedBadge = document.createElement('span');
        editedBadge.className = 'edited-badge';
        editedBadge.textContent = '(—Ä–µ–¥.)';
        timeEl.appendChild(editedBadge);
      }
      
      header.appendChild(nickEl);
      header.appendChild(timeEl);
      
      // Add edit and delete buttons for own messages
      if (msg.username === currentUser || isAdmin()) {
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.textContent = '‚úé';
        editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
        editBtn.addEventListener('click', async () => {
          await handleEditMessage(msg);
        });
        header.appendChild(editBtn);
        
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-btn';
        delBtn.textContent = '√ó';
        delBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
        delBtn.addEventListener('click', async () => {
          if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
            try {
              await deleteMessage(currentChannel, msg.id);
            } catch (error) {
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
            }
          }
        });
        header.appendChild(delBtn);
      }
      
      const text = document.createElement('div');
      text.className = 'message-text';
      text.innerHTML = linkify(escapeHtml(msg.text));
      
      body.appendChild(header);
      body.appendChild(text);
      el.appendChild(avatar);
      el.appendChild(body);
      
      return el;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    function updateTypingIndicator(typingUsers) {
      const messagesEl = document.getElementById('messages');
      let indicator = messagesEl.querySelector('.typing-indicator');
      
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∞–±–∏—Ä–∞—é—â–∏—Ö
      if (typingUsers.length === 0) {
        if (indicator) {
          indicator.classList.remove('show');
          setTimeout(() => indicator.remove(), 300);
        }
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        messagesEl.appendChild(indicator);
        
        // –î–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –ø–µ—Ä–µ–¥ –∞–Ω–∏–º–∞—Ü–∏–µ–π
        setTimeout(() => indicator.classList.add('show'), 10);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
      const usersText = typingUsers.length === 1 
        ? `${typingUsers[0]} –ø–µ—á–∞—Ç–∞–µ—Ç`
        : `${typingUsers.slice(0, -1).join(', ')} –∏ ${typingUsers[typingUsers.length - 1]} –ø–µ—á–∞—Ç–∞—é—Ç`;
      
      indicator.innerHTML = `
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <span>${usersText}</span>
      `;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä—ã –≤ —Å–ø–∏—Å–∫–µ –∫–∞–Ω–∞–ª–æ–≤
      updateTypingAvatars(typingUsers);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –Ω–∞–±–æ—Ä–∞
    function updateTypingAvatars(typingUsers) {
      const channelsList = document.getElementById('channelsList');
      const channels = channelsList.querySelectorAll('.channel');
      
      channels.forEach(channel => {
        const channelKey = channel.dataset.key;
        if (channelKey === currentChannel) {
          const avatar = channel.querySelector('.avatar');
          if (avatar) {
            if (typingUsers.length > 0) {
              avatar.classList.add('avatar-typing');
            } else {
              avatar.classList.remove('avatar-typing');
            }
          }
        }
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    function removeMessage(messageId) {
      const messagesEl = document.getElementById('messages');
      const messageEl = messagesEl.querySelector(`[data-message-id="${messageId}"]`);
      if (messageEl) {
        messageEl.style.opacity = '0';
        messageEl.style.transform = 'translateX(-20px)';
        setTimeout(() => messageEl.remove(), 300);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    function updateMessage(updatedMessage) {
      const messagesEl = document.getElementById('messages');
      const messageEl = messagesEl.querySelector(`[data-message-id="${updatedMessage.id}"]`);
      if (messageEl) {
        const textEl = messageEl.querySelector('.message-text');
        const timeEl = messageEl.querySelector('.time');
        
        if (textEl) {
          textEl.innerHTML = linkify(escapeHtml(updatedMessage.text));
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–º–µ—Ç–∫—É –æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        if (updatedMessage.edited && !timeEl.querySelector('.edited-badge')) {
          const editedBadge = document.createElement('span');
          editedBadge.className = 'edited-badge';
          editedBadge.textContent = '(—Ä–µ–¥.)';
          timeEl.appendChild(editedBadge);
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        messageEl.classList.add('message-sent');
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    async function sendMessage(channel, text) {
      const messageInput = document.getElementById('messageInput');
      const currentUser = localStorage.getItem('chat_username');
      
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      const tempMessage = {
        id: 'temp-' + Date.now(),
        text: text,
        username: currentUser,
        avatar: localStorage.getItem('chat_avatar'),
        timestamp: new Date().toISOString(),
        temp: true
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      addNewMessage(tempMessage);
      
      try {
        const result = await apiCall(`/channels/${channel}/messages`, {
          method: 'POST',
          body: JSON.stringify({ text })
        });
        
        // –ó–∞–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–µ
        const messagesEl = document.getElementById('messages');
        const tempEl = messagesEl.querySelector(`[data-message-id="${tempMessage.id}"]`);
        if (tempEl) {
          tempEl.remove();
        }
        
        // –ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ long polling
      } catch (error) {
        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        const messagesEl = document.getElementById('messages');
        const tempEl = messagesEl.querySelector(`[data-message-id="${tempMessage.id}"]`);
        if (tempEl) {
          tempEl.remove();
        }
        throw error;
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞
    async function switchChannel(channel) {
      currentChannel = channel;
      const channelData = channels[channel];
      
      document.getElementById('currentChannel').textContent = (channelData.isPrivate ? 'üîí' : '#') + channel;
      
      const description = channelData.title + ' ‚Äî ' + (channelData.isPrivate ? '–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª' : '–ø—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª');
      document.getElementById('channelDescription').textContent = description;
      
      // Show/hide add user button for private channels
      const addUserBtn = document.getElementById('addUserBtn');
      if (channelData.isPrivate) {
        addUserBtn.classList.remove('hidden');
      } else {
        addUserBtn.classList.add('hidden');
      }
      
      renderChannels(channels, currentChannel);
      await refreshMessages();
      
      // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º long polling –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
      startLongPolling();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä–∞
    const messageInput = document.getElementById('messageInput');
    messageInput.addEventListener('input', () => {
      autoResizeTextarea(messageInput);
      
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
      if (!isTyping) {
        sendTypingStatus(true);
      }
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        sendTypingStatus(false);
      }, 1000);
    });
    
    // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const originalSendHandler = document.getElementById('sendBtn').onclick;
    document.getElementById('sendBtn').onclick = async function() {
      sendTypingStatus(false);
      clearTimeout(typingTimeout);
      await originalSendHandler();
    };
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º long polling –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async () => {
      // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ...
      
      // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º long polling
      setTimeout(startLongPolling, 1000);
    });
    
    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  </script>
</body>
</html>
